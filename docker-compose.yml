version: "3.8"

services:
  # ========================
  # FRONTEND (Runtime Build)
  # ========================
  frontend:
    image: node:20-alpine
    working_dir: /app
    # Estrategia de "Runtime Build" como en tu referencia:
    # Clona el repo, instala dependencias y construye al iniciar el contenedor.
    command: >
      sh -c "
      apk add --no-cache git &&
      rm -rf ./* &&
      git clone https://github.com/alejandroqui/transportes-modular.git . &&
      npm install &&
      npm run build &&
      npx serve -s dist -l 80
      "
    networks:
      - jhamfstack
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      # Restart policy compatible con Swarm
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: "0.5"
          memory: 1024M
      labels:
        - traefik.enable=true
        
        # ğŸŒ FRONTEND HTTPS
        - traefik.http.routers.cargo-tracker.rule=Host(`transportes.regency.jhamf.com`)
        - traefik.http.routers.cargo-tracker.entrypoints=websecure
        - traefik.http.routers.cargo-tracker.tls=true
        - traefik.http.routers.cargo-tracker.tls.certresolver=letsencryptresolver
        - traefik.http.services.cargo-tracker.loadbalancer.server.port=80

        # ğŸ” Redirect HTTP â†’ HTTPS
        - traefik.http.routers.cargo-tracker-http.rule=Host(`transportes.regency.jhamf.com`)
        - traefik.http.routers.cargo-tracker-http.entrypoints=web
        - traefik.http.routers.cargo-tracker-http.middlewares=redirect-to-https
        - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
        - traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true

networks:
  jhamfstack:
    external: true
